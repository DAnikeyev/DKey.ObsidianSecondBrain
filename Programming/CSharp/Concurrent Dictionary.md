---
date_added: 2025-01-27
tags:
  - csharp
---
Up: [Concurrent collection](Concurrent%20collection.md)
___
ConcurrentDictionary\<TKey,TValue> uses fine-grained locking when adding to or updating data in the dictionary, but it is entirely lock-free for read operations.  In this way, it’s optimized for scenarios where reading from the dictionary is the most frequent operation.
# Methods

| To do this                                                                                                                           | Use this method                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Usage notes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Add a new key to the dictionary, if it doesn't already exist in the dictionary                                                       | [TryAdd](https://learn.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2.tryadd?view=net-9.0)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | This method adds the specified key/value pair, if the key doesn't currently exist in the dictionary. The method returns `true` or `false` depending on whether the new pair was added.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| Update the value for an existing key in the dictionary, if that key has a specific value                                             | [TryUpdate](https://learn.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2.tryupdate?view=net-9.0)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | This method checks whether the key has a specified value, and if it does, updates the key with a new value. It's similar to the [CompareExchange](https://learn.microsoft.com/en-us/dotnet/api/system.threading.interlocked.compareexchange?view=net-9.0) method, except that it's used for dictionary elements.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Store a key/value pair in the dictionary unconditionally, and overwrite the value of a key that already exists                       | The indexer's setter: `dictionary[key] = newValue`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| Add a key/value pair to the dictionary, or if the key already exists, update the value for the key based on the key's existing value | [AddOrUpdate(TKey, Func<TKey,TValue>, Func<TKey,TValue,TValue>)](https://learn.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2.addorupdate?view=net-9.0#system-collections-concurrent-concurrentdictionary-2-addorupdate(-0-system-func((-0-1))-system-func((-0-1-1))))  <br>  <br>-or-  <br>  <br>[AddOrUpdate(TKey, TValue, Func<TKey,TValue,TValue>)](https://learn.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2.addorupdate?view=net-9.0#system-collections-concurrent-concurrentdictionary-2-addorupdate(-0-1-system-func((-0-1-1)))) | [AddOrUpdate(TKey, Func<TKey,TValue>, Func<TKey,TValue,TValue>)](https://learn.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2.addorupdate?view=net-9.0#system-collections-concurrent-concurrentdictionary-2-addorupdate(-0-system-func((-0-1))-system-func((-0-1-1)))) accepts the key and two delegates. It uses the first delegate if the key doesn't exist in the dictionary; it accepts the key and returns the value that should be added for the key. It uses the second delegate if the key does exist; it accepts the key and its current value, and it returns the new value that should be set for the key.  <br>  <br>[AddOrUpdate(TKey, TValue, Func<TKey,TValue,TValue>)](https://learn.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2.addorupdate?view=net-9.0#system-collections-concurrent-concurrentdictionary-2-addorupdate(-0-1-system-func((-0-1-1)))) accepts the key, a value to add, and the update delegate. This is the same as the previous overload, except that it doesn't use a delegate to add a key. |
| Get the value for a key in the dictionary, adding the value to the dictionary and returning it if the key doesn't exist              | [GetOrAdd(TKey, TValue)](https://learn.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2.getoradd?view=net-9.0#system-collections-concurrent-concurrentdictionary-2-getoradd(-0-1))  <br>  <br>-or-  <br>  <br>[GetOrAdd(TKey, Func<TKey,TValue>)](https://learn.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2.getoradd?view=net-9.0#system-collections-concurrent-concurrentdictionary-2-getoradd(-0-system-func((-0-1))))                                                                                                                   | These overloads provide lazy initialization for a key/value pair in the dictionary, adding the value only if it's not there.  <br>  <br>[GetOrAdd(TKey, TValue)](https://learn.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2.getoradd?view=net-9.0#system-collections-concurrent-concurrentdictionary-2-getoradd(-0-1)) takes the value to be added if the key doesn't exist.  <br>  <br>[GetOrAdd(TKey, Func<TKey,TValue>)](https://learn.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2.getoradd?view=net-9.0#system-collections-concurrent-concurrentdictionary-2-getoradd(-0-system-func((-0-1)))) takes a delegate that will generate the value if the key doesn't exist.                                                                                                                                                                                                                                                                                                                                                     |


 ```cs
 class CD_Ctor
{
        // Demonstrates:
        //      ConcurrentDictionary<TKey, TValue> ctor(concurrencyLevel, initialCapacity)
        //      ConcurrentDictionary<TKey, TValue>[TKey]
        static void Main()
        {
            // We know how many items we want to insert into the ConcurrentDictionary.
            // So set the initial capacity to some prime number above that, to ensure that
            // the ConcurrentDictionary does not need to be resized while initializing it.
            int NUMITEMS = 64;
            int initialCapacity = 101;

            // The higher the concurrencyLevel, the higher the theoretical number of operations
            // that could be performed concurrently on the ConcurrentDictionary.  However, global
            // operations like resizing the dictionary take longer as the concurrencyLevel rises.
            // For the purposes of this example, we'll compromise at numCores * 2.
            int numProcs = Environment.ProcessorCount;
            int concurrencyLevel = numProcs * 2;

            // Construct the dictionary with the desired concurrencyLevel and initialCapacity
            ConcurrentDictionary<int, int> cd = new ConcurrentDictionary<int, int>(concurrencyLevel, initialCapacity);

            // Initialize the dictionary
            for (int i = 0; i < NUMITEMS; i++) cd[i] = i * i;

            Console.WriteLine("The square of 23 is {0} (should be {1})", cd[23], 23 * 23);
        }
}
```

## Concurency level

How Concurrency Level Works

The concurrency level is used to determine the number of locks that the `ConcurrentDictionary` will use internally. Here's how it generally works:

1. **Partitioning**: The dictionary is internally partitioned into several segments, each protected by its own lock. The number of segments is typically based on the specified concurrency level.
    
2. **Lock Striping**: By having multiple locks (one for each segment), the dictionary allows multiple threads to perform operations on different segments concurrently. This reduces contention compared to using a single lock for the entire dictionary.
    
3. **Load Balancing**: The concurrency level helps balance the load across these segments. If the concurrency level is set too low, it might lead to more contention as multiple threads try to access the same segment. If it's set too high, it might lead to unnecessary overhead from managing too many locks.
# Links
```dataview
LIST
FROM [[]]
WHERE contains(file.name, "")
SORT file.name ASC
```
